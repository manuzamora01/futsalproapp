<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futsal Pro Manager</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003cc5">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary-blue: #003cc5; --soft-blue: #eef2ff; --dark-blue: #001f66; --bg-body: #f4f7fa; }
        body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; padding-bottom: 120px; }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white; padding: 25px 0; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .nav-pills .nav-link { color: white; opacity: 0.7; font-weight: 600; border-radius: 10px; }
        .nav-pills .nav-link.active { background-color: rgba(255,255,255,0.2); opacity: 1; }

        .card-main { border: none; border-radius: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: -20px; }
        
        .pos-portero { border-left: 8px solid #ffc107 !important; }
        .pos-cierre { border-left: 8px solid #0d6efd !important; }
        .pos-ala-izquierda { border-left: 8px solid #198754 !important; }
        .pos-ala-derecha { border-left: 8px solid #0dcaf0 !important; }
        .pos-pivot { border-left: 8px solid #dc3545 !important; }

        .player-item { background: white; border-radius: 12px !important; margin-bottom: 10px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .dorsal-badge { background-color: var(--soft-blue); color: var(--primary-blue); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 800; }
        
        .sticky-action { position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 1000; }
        .btn-generate { background: var(--primary-blue); color: white; border-radius: 15px; padding: 16px; font-weight: 700; width: 100%; border: none; box-shadow: 0 8px 20px rgba(0, 60, 197, 0.3); }
        
        .form-control, .form-select { border-radius: 12px; border: 1.5px solid #e2e8f0; padding: 10px; }

        #btnInstall {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            color: white; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px; font-weight: 600; font-size: 0.8rem;
        }
    </style>
</head>
<body>

<div class="app-header mb-4">
    <div class="container px-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-800 mb-0 text-white">PRO FUTSAL</h2>
                <p class="small opacity-75 mb-0 text-white">Panel de Control</p>
            </div>
            <button id="btnInstall" class="btn btn-sm d-none" onclick="instalarApp()">
                <i class="bi bi-download me-1"></i> INSTALAR APP
            </button>
        </div>
        <ul class="nav nav-pills nav-justified mt-4" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-conv">CONVOCATORIA</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-fairplay">ROTACIONES</button>
            </li>
        </ul>
    </div>
</div>

<div class="container mt-2">
    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-conv">
            <div class="card card-main mb-4 p-3 shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="small fw-bold text-muted text-uppercase">Equipo</label>
                    <button class="btn btn-sm text-danger" onclick="eliminarEquipoActual()" id="btnBorrarEquipo" style="display:none;"><i class="bi bi-trash3"></i></button>
                </div>
                <div class="d-flex gap-2">
                    <select id="selectEquipo" class="form-select" onchange="actualizarInterfaz()"></select>
                    <button class="btn btn-primary px-3" data-bs-toggle="modal" data-bs-target="#modalEquipo"><i class="bi bi-plus-lg"></i></button>
                </div>
            </div>

            <div id="seccionJugadores" style="display:none;">
                <div class="card border-0 rounded-4 shadow-sm mb-4 p-3">
                    <div class="row g-2 mb-2">
                        <div class="col-12"><input type="text" id="infoRival" class="form-control bg-light" placeholder="Nombre del Rival"></div>
                        <div class="col-6"><input type="date" id="infoFecha" class="form-control bg-light"></div>
                        <div class="col-6"><input type="time" id="infoHora" class="form-control bg-light"></div>
                        <div class="col-12"><input type="text" id="horaCitacion" class="form-control bg-light" placeholder="Hora de Citaci√≥n (ej: 18:00)"></div>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" id="linkMaps" class="form-control bg-light border-end-0" placeholder="Link de Google Maps">
                        <button class="btn btn-outline-primary bg-light border-start-0" onclick="window.open('https://www.google.com/maps', '_blank')"><i class="bi bi-search"></i></button>
                    </div>
                    <textarea id="mensajeCierre" class="form-control bg-light" rows="1" placeholder="Intrucciones adicionales"></textarea>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                    <h5 class="fw-bold mb-0">Jugadores</h5>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="abrirModalNuevoJugador()">
                        <i class="bi bi-person-plus me-1"></i> A√±adir
                    </button>
                </div>
                <ul class="list-group mb-5 shadow-sm" id="listaJugadores"></ul>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-fairplay">
            <div class="card border-0 rounded-4 shadow-sm p-4 mb-4">
                <h6 class="fw-bold text-primary mb-3">REPARTO AUTOM√ÅTICO</h6>
                <div class="row g-3">
                    <div class="col-6"><label class="small fw-bold">Partido (min)</label><input type="number" id="matchDuration" class="form-control" value="40"></div>
                    <div class="col-6"><label class="small fw-bold">Turnos (min)</label><input type="number" id="shiftDuration" class="form-control" value="5"></div>
                </div>
                <button class="btn btn-primary mt-4 fw-bold py-3 w-100 rounded-4" onclick="generarPlanRotacion()">
                    <i class="bi bi-file-pdf me-2"></i>GENERAR PDF T√ÅCTICO
                </button>
            </div>
        </div>
    </div>
</div>

<div class="sticky-action">
    <button class="btn btn-generate shadow-lg" onclick="generarConvocatoria()">
        <i class="bi bi-whatsapp me-2"></i> ENVIAR A WHATSAPP
    </button>
</div>

<div class="modal fade" id="modalJugador" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold text-primary" id="tituloModalJugador">Ficha T√©cnica</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editandoJugadorId">
                <div class="row g-3">
                    <div class="col-4"><label class="small fw-bold">Dorsal</label><input type="number" id="numJugador" class="form-control text-center" placeholder="00"></div>
                    <div class="col-8"><label class="small fw-bold">Nombre</label><input type="text" id="nombreJugador" class="form-control"></div>
                    <div class="col-12"><label class="small fw-bold">Posici√≥n Principal</label>
                        <select id="posicionJugador" class="form-select">
                            <option value="Portero">Portero</option><option value="Cierre">Cierre</option>
                            <option value="Ala Izquierda">Ala Izquierda</option><option value="Ala Derecha">Ala Derecha</option><option value="Pivot">Pivot</option>
                        </select>
                    </div>
                    <div class="col-12"><label class="small fw-bold text-muted">Posici√≥n Secundaria (Opcional)</label>
                        <select id="posSecJugador" class="form-select">
                            <option value="">Ninguna</option><option value="Cierre">Cierre</option>
                            <option value="Ala Izquierda">Ala Izquierda</option><option value="Ala Derecha">Ala Derecha</option><option value="Pivot">Pivot</option>
                        </select>
                    </div>
                    <div class="col-12"><label class="small fw-bold text-danger">Evitar que coincida con:</label>
                        <select id="evitarJugadorId" class="form-select">
                            <option value="">Nadie espec√≠fico</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0"><button onclick="guardarJugador()" class="btn btn-primary w-100 py-3 rounded-4 fw-bold">GUARDAR</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEquipo" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 rounded-4 shadow">
            <div class="modal-body py-4 text-center">
                <h6 class="fw-bold mb-3 text-primary">Nombre del Equipo</h6>
                <input type="text" id="nombreNuevoEquipo" class="form-control mb-3 text-center">
                <button onclick="guardarEquipo()" class="btn btn-primary w-100 rounded-4">Crear</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let datos = JSON.parse(localStorage.getItem('appFutsalV14')) || { equipos: [], jugadores: [] };
    const ordenTactico = { "Portero": 1, "Cierre": 2, "Ala Izquierda": 3, "Ala Derecha": 4, "Pivot": 5 };

    function guardarEnStorage() { localStorage.setItem('appFutsalV14', JSON.stringify(datos)); }

    // --- PWA INSTALACI√ìN ---
    let eventInstall;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        eventInstall = e;
        document.getElementById('btnInstall').classList.remove('d-none');
    });

    function instalarApp() {
        if(eventInstall) {
            eventInstall.prompt();
            eventInstall = null;
            document.getElementById('btnInstall').classList.add('d-none');
        }
    }

    // --- LOGICA DE EQUIPOS ---
    function guardarEquipo() {
        const input = document.getElementById('nombreNuevoEquipo');
        if(!input.value) return;
        const nuevo = { id: Date.now(), nombre: input.value };
        datos.equipos.push(nuevo);
        guardarEnStorage();
        cargarEquipos();
        document.getElementById('selectEquipo').value = nuevo.id;
        bootstrap.Modal.getInstance(document.getElementById('modalEquipo')).hide();
        actualizarInterfaz();
        input.value = "";
    }

    function cargarEquipos() {
        const select = document.getElementById('selectEquipo');
        select.innerHTML = '<option value="">-- Elige Equipo --</option>';
        datos.equipos.forEach(e => select.innerHTML += `<option value="${e.id}">${e.nombre}</option>`);
    }

    function eliminarEquipoActual() {
        const id = document.getElementById('selectEquipo').value;
        if(id && confirm("¬øBorrar equipo y jugadores?")) {
            datos.equipos = datos.equipos.filter(e => e.id != id);
            datos.jugadores = datos.jugadores.filter(j => j.equipoId != id);
            guardarEnStorage();
            cargarEquipos();
            actualizarInterfaz();
        }
    }

    // --- LOGICA DE JUGADORES ---
    function abrirModalNuevoJugador() {
        document.getElementById('editandoJugadorId').value = "";
        document.getElementById('nombreJugador').value = "";
        document.getElementById('numJugador').value = "";
        document.getElementById('posSecJugador').value = "";
        actualizarSelectEvitar();
        document.getElementById('tituloModalJugador').innerText = "Nuevo Jugador";
        new bootstrap.Modal(document.getElementById('modalJugador')).show();
    }

    function actualizarSelectEvitar(excluirId = null) {
        const eqId = document.getElementById('selectEquipo').value;
        const select = document.getElementById('evitarJugadorId');
        select.innerHTML = '<option value="">Nadie espec√≠fico</option>';
        datos.jugadores.filter(j => j.equipoId == eqId && j.id != excluirId).forEach(j => {
            select.innerHTML += `<option value="${j.id}">${j.nombre}</option>`;
        });
    }

    function guardarJugador() {
        const eqId = document.getElementById('selectEquipo').value;
        const nombre = document.getElementById('nombreJugador').value;
        const num = document.getElementById('numJugador').value || "0";
        const pos = document.getElementById('posicionJugador').value;
        const posSec = document.getElementById('posSecJugador').value;
        const evitarId = document.getElementById('evitarJugadorId').value;
        const editId = document.getElementById('editandoJugadorId').value;

        if(!nombre) return;
        const playerObj = { id: editId || Date.now(), equipoId: eqId, nombre, numero: num, pos, posSec, evitarId };

        if(editId) {
            const idx = datos.jugadores.findIndex(j => j.id == editId);
            datos.jugadores[idx] = playerObj;
        } else {
            datos.jugadores.push(playerObj);
        }
        guardarEnStorage();
        bootstrap.Modal.getInstance(document.getElementById('modalJugador')).hide();
        actualizarInterfaz();
    }

    function editarJugador(id) {
        const j = datos.jugadores.find(p => p.id == id);
        actualizarSelectEvitar(id);
        document.getElementById('editandoJugadorId').value = j.id;
        document.getElementById('nombreJugador').value = j.nombre;
        document.getElementById('numJugador').value = j.numero;
        document.getElementById('posicionJugador').value = j.pos;
        document.getElementById('posSecJugador').value = j.posSec || "";
        document.getElementById('evitarJugadorId').value = j.evitarId || "";
        document.getElementById('tituloModalJugador').innerText = "Editar Jugador";
        new bootstrap.Modal(document.getElementById('modalJugador')).show();
    }

    function borrarJugador(id) {
        if(confirm("¬øEliminar jugador?")) {
            datos.jugadores = datos.jugadores.filter(j => j.id != id);
            guardarEnStorage();
            actualizarInterfaz();
        }
    }

    function actualizarInterfaz() {
        const eqId = document.getElementById('selectEquipo').value;
        const lista = document.getElementById('listaJugadores');
        if(!eqId) { document.getElementById('seccionJugadores').style.display='none'; document.getElementById('btnBorrarEquipo').style.display='none'; return; }
        document.getElementById('seccionJugadores').style.display='block';
        document.getElementById('btnBorrarEquipo').style.display='block';
        lista.innerHTML = "";
        datos.jugadores.filter(j => j.equipoId == eqId).sort((a,b) => ordenTactico[a.pos] - ordenTactico[b.pos]).forEach(j => {
            const pCls = `pos-${j.pos.toLowerCase().replace(/ /g, '-')}`;
            lista.innerHTML += `
                <li class="list-group-item d-flex align-items-center player-item ${pCls} px-3 py-3 border-0">
                    <input class="form-check-input check-jugador me-3" type="checkbox" data-id="${j.id}" style="width:26px; height:24px;">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <div class="dorsal-badge me-2">${j.numero}</div>
                            <h6 class="mb-0 fw-bold">${j.nombre}</h6>
                        </div>
                        <small class="text-muted fw-bold">${j.pos.toUpperCase()} ${j.posSec ? '/ '+j.posSec.toUpperCase() : ''}</small>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary border-0" onclick="editarJugador(${j.id})"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="borrarJugador(${j.id})"><i class="bi bi-trash"></i></button>
                    </div>
                </li>`;
        });
    }

    // --- WHATSAPP ---
    function generarConvocatoria() {
        const rival = document.getElementById('infoRival').value || "Rival";
        const fecha = document.getElementById('infoFecha').value || "Pendiente";
        const hora = document.getElementById('infoHora').value || "Pendiente";
        const citacion = document.getElementById('horaCitacion').value || "Pendiente";
        const maps = document.getElementById('linkMaps').value || "Maps";
        const cierre = document.getElementById('mensajeCierre').value;
        const checks = Array.from(document.querySelectorAll('.check-jugador:checked'));
        if(checks.length === 0) { alert("Selecciona jugadores."); return; }

        let m = `‚öΩ *CONVOCATORIA* \n`;
        m += `üèüÔ∏è *PARTIDO:* ${rival}\nüìÖ *FECHA:* ${fecha}\nüïí *HORA:* ${hora}\n‚åö *CITACI√ìN:* ${citacion}\nüìç *MAPS:* ${maps}\n\nüèÉ *LISTA:* \n`;
        checks.forEach(c => { const p = datos.jugadores.find(j => j.id == c.getAttribute('data-id')); m += `üëï #${p.numero} ${p.nombre} (${p.pos})\n`; });
        m += `\nüìù *${cierre}*`;
        window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(m), '_blank');
    }

    // --- PDF ROTACI√ìN AUTOM√ÅTICA ---
    function generarPlanRotacion() {
        const { jsPDF } = window.jspdf;
        const totalT = parseInt(document.getElementById('matchDuration').value);
        const shiftT = parseInt(document.getElementById('shiftDuration').value);
        const checks = Array.from(document.querySelectorAll('.check-jugador:checked'));
        if(checks.length < 5) { alert("M√≠nimo 5 jugadores."); return; }
        
        const convocados = checks.map(c => datos.jugadores.find(j => j.id == c.getAttribute('data-id')));
        const minJugados = {}; convocados.forEach(j => minJugados[j.id] = 0);
        const numTurnos = totalT / shiftT;
        const turnos = [];

        for(let i=0; i < numTurnos; i++) {
            const quinteto = [];
            const posiciones = ["Portero", "Cierre", "Ala Izquierda", "Ala Derecha", "Pivot"];
            
            posiciones.forEach(pos => {
                let candidatos = convocados.filter(j => !quinteto.includes(j)).sort((a,b) => minJugados[a.id] - minJugados[b.id]);
                
                // Prioridad 1: Jugadores que su posici√≥n principal es la buscada Y no coincidan con su "evitar"
                let elegido = candidatos.find(j => j.pos === pos && !quinteto.some(q => q.id == j.evitarId || j.id == q.evitarId));
                
                // Prioridad 2: Jugadores cuya posici√≥n secundaria es la buscada
                if(!elegido) elegido = candidatos.find(j => j.posSec === pos && !quinteto.some(q => q.id == j.evitarId || j.id == q.evitarId));
                
                // Prioridad 3: Cualquiera con menos minutos que no rompa la regla de "evitar"
                if(!elegido) elegido = candidatos.find(j => !quinteto.some(q => q.id == j.evitarId || j.id == q.evitarId));
                
                // Si a√∫n no hay nadie (muy raro), el primero disponible
                if(!elegido) elegido = candidatos[0];

                quinteto.push(elegido);
                minJugados[elegido.id] += shiftT;
            });
            turnos.push({ t: `${i*shiftT}-${(i+1)*shiftT}`, j: quinteto });
        }

        const doc = new jsPDF('l', 'pt');
        doc.setFontSize(18); doc.text("PLAN DE ROTACIONES AUTOM√ÅTICO", 40, 40);
        const body = turnos.map(tu => [tu.t, ...tu.j.map(ju => ju.nombre)]);
        doc.autoTable({ head: [['Turno', 'Portero', 'Cierre', 'Ala Izq.', 'Ala Der.', 'Pivot']], body: body, startY: 60, theme: 'striped', headStyles: {fillColor: [0, 60, 197]} });
        window.open(doc.output('bloburl'), '_blank');
    }

    cargarEquipos();
</script>
</body>
</html>