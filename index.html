<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futsal Pro Manager</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003cc5">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary-blue: #003cc5; --dark-blue: #001f66; --bg: #f4f7fa; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; padding-bottom: 110px; }
        .app-header { background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue)); color: white; padding: 20px 0; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; }
        .nav-pills .nav-link { color: white; opacity: 0.7; font-weight: 600; border-radius: 10px; }
        .nav-pills .nav-link.active { background-color: rgba(255,255,255,0.2); opacity: 1; }
        .card-main { border: none; border-radius: 20px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: -20px; }
        .player-item { border: none; border-radius: 15px !important; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .pos-portero { border-left: 8px solid #ffc107 !important; }
        .pos-cierre { border-left: 8px solid #0d6efd !important; }
        .pos-ala-izq { border-left: 8px solid #198754 !important; }
        .pos-ala-der { border-left: 8px solid #0dcaf0 !important; }
        .pos-pivot { border-left: 8px solid #dc3545 !important; }
    </style>
</head>
<body>

<div class="app-header text-center mb-4">
    <div class="container">
        <h2 class="fw-800 mb-0">PRO FUTSAL</h2>
        <ul class="nav nav-pills nav-justified mt-3 px-3" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-conv">CONVOCATORIA</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-rot">ROTACIONES</button></li>
        </ul>
    </div>
</div>

<div class="container mt-2">
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-conv">
            <div class="card card-main p-3 mb-4">
                <label class="small fw-bold text-muted text-uppercase mb-2">Equipo</label>
                <div class="d-flex gap-2">
                    <select id="selectEquipo" class="form-select" onchange="actualizarInterfaz()"></select>
                    <button class="btn btn-primary px-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalEquipo">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>

            <div id="seccionJugadores" style="display:none;">
                <div class="card border-0 rounded-4 shadow-sm p-3 mb-4">
                    <input type="text" id="infoPart" class="form-control mb-2" placeholder="Rival y Fecha">
                    <input type="text" id="infoCit" class="form-control mb-2" placeholder="Hora de Citaci√≥n">
                    <input type="text" id="infoMaps" class="form-control mb-2" placeholder="Enlace Ubicaci√≥n">
                    <textarea id="infoFinal" class="form-control" rows="2" placeholder="Instrucciones finales para WhatsApp"></textarea>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                    <h5 class="fw-bold mb-0">Plantilla</h5>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#modalJugador" onclick="prepararNuevoJugador()">+ A√±adir</button>
                </div>
                <ul class="list-group mb-5" id="listaJugadores"></ul>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-rot">
            <div class="card border-0 rounded-4 shadow-sm p-3 mb-4">
                <h6 class="fw-bold text-primary mb-3">Planificaci√≥n de Minutos (Fair Play)</h6>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small fw-bold">Partido (min)</label><input type="number" id="mTot" class="form-control" value="40"></div>
                    <div class="col-6"><label class="small fw-bold">Turnos c/ (min)</label><input type="number" id="mRot" class="form-control" value="5"></div>
                </div>
                <label class="small fw-bold">Normas del Entrenador para el PDF</label>
                <textarea id="normasCoach" class="form-control mb-3" rows="2" placeholder="Ej: No cambiar al portero. Todos juegan 20 min."></textarea>
                <button class="btn btn-primary w-100 fw-bold py-3 shadow" onclick="generarPDFRotaciones()">
                    <i class="bi bi-file-earmark-pdf-fill me-2"></i>GENERAR PDF DE ROTACIONES
                </button>
            </div>
        </div>
    </div>
</div>

<div class="fixed-bottom p-3">
    <button class="btn btn-success btn-lg shadow w-100 py-3 fw-bold" onclick="enviarWhatsApp()"><i class="bi bi-whatsapp me-2"></i>ENVIAR POR WHATSAPP</button>
</div>

<div class="modal fade" id="modalEquipo" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content border-0 rounded-4 shadow"><div class="modal-body p-4 text-center">
    <h6 class="fw-bold mb-3 text-primary">Nombre del Equipo</h6>
    <input type="text" id="nuevoEqNombre" class="form-control mb-3 text-center">
    <button onclick="crearEquipo()" class="btn btn-primary w-100 rounded-3 fw-bold">CREAR EQUIPO</button>
</div></div></div></div>

<div class="modal fade" id="modalJugador" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4 shadow">
    <div class="modal-header border-0 pb-0"><h5 class="fw-bold text-primary">Ficha del Jugador</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <input type="hidden" id="editJugId">
        <div class="row g-3">
            <div class="col-4"><label class="small fw-bold">Dorsal</label><input type="number" id="jNum" class="form-control text-center" placeholder="00"></div>
            <div class="col-8"><label class="small fw-bold">Nombre</label><input type="text" id="jNom" class="form-control"></div>
            <div class="col-6"><label class="small fw-bold">Posici√≥n 1</label>
                <select id="jPos1" class="form-select"><option value="Portero">Portero</option><option value="Cierre">Cierre</option><option value="Ala Izquierda">Ala Izquierda</option><option value="Ala Derecha">Ala Derecha</option><option value="Pivot">Pivot</option></select>
            </div>
            <div class="col-6"><label class="small fw-bold">Posici√≥n 2</label>
                <select id="jPos2" class="form-select"><option value="Ninguna">Ninguna</option><option value="Portero">Portero</option><option value="Cierre">Cierre</option><option value="Ala Izquierda">Ala Izquierda</option><option value="Ala Derecha">Ala Derecha</option><option value="Pivot">Pivot</option></select>
            </div>
            <div class="col-12"><label class="small fw-bold">Evitar coincidir con:</label><select id="jEvitar" class="form-select"><option value="">Ninguno</option></select></div>
        </div>
    </div>
    <div class="modal-footer border-0"><button onclick="guardarJugador()" class="btn btn-primary w-100 py-3 rounded-3 fw-bold">GUARDAR FICHA</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let db = JSON.parse(localStorage.getItem('futsal_pwa_vFinal')) || { equipos: [], jugadores: [] };
    const save = () => localStorage.setItem('futsal_pwa_vFinal', JSON.stringify(db));

    function crearEquipo() {
        const nom = document.getElementById('nuevoEqNombre').value;
        if(!nom) return;
        const n = { id: Date.now(), nombre: nom };
        db.equipos.push(n); save();
        refreshEquipos();
        document.getElementById('selectEquipo').value = n.id;
        bootstrap.Modal.getInstance(document.getElementById('modalEquipo')).hide();
        actualizarInterfaz();
        document.getElementById('nuevoEqNombre').value = "";
    }

    function refreshEquipos() {
        const sel = document.getElementById('selectEquipo');
        sel.innerHTML = '<option value="">-- Elige un equipo --</option>';
        db.equipos.forEach(e => sel.innerHTML += `<option value="${e.id}">${e.nombre}</option>`);
    }

    function prepararNuevoJugador() {
        document.getElementById('editJugId').value = "";
        document.getElementById('jNom').value = "";
        document.getElementById('jNum').value = "";
        const evitar = document.getElementById('jEvitar');
        evitar.innerHTML = '<option value="">Ninguno</option>';
        const eqId = document.getElementById('selectEquipo').value;
        db.jugadores.filter(j => j.equipoId == eqId).forEach(j => {
            evitar.innerHTML += `<option value="${j.id}">${j.nombre}</option>`;
        });
    }

    function guardarJugador() {
        const eqId = document.getElementById('selectEquipo').value;
        const j = {
            id: document.getElementById('editJugId').value || Date.now(),
            equipoId: eqId,
            nombre: document.getElementById('jNom').value,
            numero: document.getElementById('jNum').value || "0",
            pos1: document.getElementById('jPos1').value,
            pos2: document.getElementById('jPos2').value,
            evitar: document.getElementById('jEvitar').value
        };
        if(!j.nombre) return;
        const idx = db.jugadores.findIndex(p => p.id == j.id);
        if(idx > -1) db.jugadores[idx] = j; else db.jugadores.push(j);
        save();
        bootstrap.Modal.getInstance(document.getElementById('modalJugador')).hide();
        actualizarInterfaz();
    }

    function actualizarInterfaz() {
        const eqId = document.getElementById('selectEquipo').value;
        const list = document.getElementById('listaJugadores');
        if(!eqId) { document.getElementById('seccionJugadores').style.display='none'; return; }
        document.getElementById('seccionJugadores').style.display='block';
        list.innerHTML = "";
        db.jugadores.filter(j => j.equipoId == eqId).forEach(j => {
            const posClass = `pos-${j.pos1.toLowerCase().replace(/ /g, "-")}`;
            list.innerHTML += `
                <li class="list-group-item d-flex align-items-center player-item ${posClass} p-3">
                    <input class="form-check-input check-j me-3" type="checkbox" data-id="${j.id}" style="width:26px; height:26px;">
                    <div class="flex-grow-1"><strong>${j.numero}. ${j.nombre}</strong><br><small class="text-muted">${j.pos1} ${j.pos2 != 'Ninguna' ? '/ ' + j.pos2 : ''}</small></div>
                    <button class="btn btn-sm btn-light border" onclick="editJ(${j.id})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-light text-danger ms-1" onclick="delJ(${j.id})"><i class="bi bi-trash"></i></button>
                </li>`;
        });
    }

    function editJ(id) {
        const j = db.jugadores.find(p => p.id == id);
        prepararNuevoJugador();
        document.getElementById('editJugId').value = j.id;
        document.getElementById('jNom').value = j.nombre;
        document.getElementById('jNum').value = j.numero;
        document.getElementById('jPos1').value = j.pos1;
        document.getElementById('jPos2').value = j.pos2;
        document.getElementById('jEvitar').value = j.evitar;
        new bootstrap.Modal(document.getElementById('modalJugador')).show();
    }

    function delJ(id) { if(confirm("¬øEliminar?")) { db.jugadores = db.jugadores.filter(j => j.id != id); save(); actualizarInterfaz(); } }

    function enviarWhatsApp() {
        const checks = Array.from(document.querySelectorAll('.check-j:checked'));
        if(!checks.length) return alert("Selecciona jugadores primero");
        const eq = document.getElementById('selectEquipo').options[document.getElementById('selectEquipo').selectedIndex].text;
        let m = `‚öΩ *CONVOCATORIA: ${eq.toUpperCase()}*\n`;
        m += `------------------------------------------\n`;
        m += `üèüÔ∏è *PARTIDO:* ${document.getElementById('infoPart').value}\nüïí *CITACI√ìN:* ${document.getElementById('infoCit').value}\nüìç *MAPS:* ${document.getElementById('infoMaps').value}\n`;
        m += `------------------------------------------\n\nüèÉ *CONVOCADOS:* \n`;
        checks.forEach(c => { const p = db.jugadores.find(j => j.id == c.dataset.id); m += `üëï #${p.numero} ${p.nombre} (${p.pos1})\n`; });
        m += `\nüìù *NOTAS:* ${document.getElementById('infoFinal').value}`;
        window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(m));
    }

    function generarPDFRotaciones() {
        const { jsPDF } = window.jspdf;
        const total = parseInt(document.getElementById('mTot').value);
        const shift = parseInt(document.getElementById('mRot').value);
        const checks = Array.from(document.querySelectorAll('.check-j:checked'));
        if(checks.length < 5) return alert("M√≠nimo 5 jugadores para rotar");

        const conv = checks.map(c => db.jugadores.find(j => j.id == c.dataset.id));
        let mins = {}; conv.forEach(j => mins[j.id] = 0);
        let turnos = [];

        for (let i = 0; i < total/shift; i++) {
            let pista = [];
            const posiciones = ["Portero", "Cierre", "Ala Izquierda", "Ala Derecha", "Pivot"];
            posiciones.forEach(p => {
                let cand = conv.filter(j => !pista.includes(j) && (j.pos1 === p || j.pos2 === p)).sort((a,b) => mins[a.id] - mins[b.id]);
                if(!cand.length) cand = conv.filter(j => !pista.includes(j)).sort((a,b) => mins[a.id] - mins[b.id]);
                const elegido = cand.find(j => !pista.some(pJ => pJ.id == j.evitar)) || cand[0];
                pista.push(elegido); mins[elegido.id] += shift;
            });
            turnos.push([`${i*shift}-${(i+1)*shift}`, ...pista.map(p => p.nombre)]);
        }

        const doc = new jsPDF('l', 'pt');
        doc.text("TABLA DE CAMBIOS FAIR PLAY", 40, 40);
        doc.setFontSize(10);
        doc.text(`Normas: ${document.getElementById('normasCoach').value}`, 40, 60);
        doc.autoTable({ head: [['Turno', 'Portero', 'Cierre', 'Ala Izq.', 'Ala Der.', 'Pivot']], body: turnos, startY: 80 });
        window.open(doc.output('bloburl'), '_blank');
    }

    refreshEquipos();
</script>
</body>
</html>